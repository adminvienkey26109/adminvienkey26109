<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Tool T√†i X·ªâu API + ƒê·∫øm d√≤ng code</title>
  <style>
    body { font-family: Arial; background: #222; color: #eee; padding: 20px; text-align: center; }
    #dice { font-size: 50px; margin: 10px 0; }
    #result { font-size: 24px; margin: 10px 0; }
    #history { max-width: 600px; margin: 20px auto; text-align: left; }
    .history-item { background: #333; padding: 8px; margin: 5px 0; border-radius: 6px; }
    button { padding: 10px 20px; border: none; border-radius: 6px; background: #00bfff; color: white; cursor: pointer; font-size: 16px; }
    button:hover { background: #0099cc; }
    #codeLineCount { margin-top: 20px; font-style: italic; color: #aaa; }
  </style>
</head>
<body>

  <h1>Tool T√†i X·ªâu API + ƒê·∫øm s·ªë d√≤ng code</h1>
  <p>Phi√™n: <span id="phien">--</span></p>
  <div id="dice">üé≤üé≤üé≤</div>
  <div id="total">T·ªïng: --</div>
  <div id="result">K·∫øt qu·∫£: --</div>
  <button id="btnLoad">C·∫≠p nh·∫≠t d·ªØ li·ªáu</button>

  <div id="history">
    <h3>L·ªãch s·ª≠</h3>
  </div>

  <div id="codeLineCount"></div>

<script>
  let history = [];

  // H√†m g·ªçi API qua proxy AllOrigins ƒë·ªÉ tr√°nh CORS
  async function loadData() {
    const apiUrl = "https://taixiu.system32-cloudfare-356783752985678522.monster/api/luckydice/GetSoiCau";
    const proxyUrl = "https://api.allorigins.win/raw?url=" + encodeURIComponent(apiUrl) + "&timestamp=" + Date.now();

    try {
      const res = await fetch(proxyUrl, { cache: "no-store" });
      const data = await res.json();

      if (!data.data || !data.data.length) {
        alert("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu h·ª£p l·ªá t·ª´ API");
        return;
      }

      const item = data.data[0];

      // Hi·ªÉn th·ªã d·ªØ li·ªáu
      document.getElementById("phien").textContent = item.phien;
      document.getElementById("dice").textContent = item.ketQua.split("-").map(() => "üé≤").join("");
      document.getElementById("total").textContent = "T·ªïng: " + item.tong;
      document.getElementById("result").textContent = "K·∫øt qu·∫£: " + item.taiXiu;

      // L∆∞u l·ªãch s·ª≠
      history.unshift(item);
      if (history.length > 10) history.pop();
      renderHistory();

      // ƒê·∫øm s·ªë d√≤ng code c·ªßa file n√†y (t·ª± g·ªçi ch√≠nh file HTML)
      countCodeLines();

    } catch (err) {
      alert("L·ªói khi g·ªçi API: " + err.message);
      console.error(err);
    }
  }

  // Hi·ªÉn th·ªã l·ªãch s·ª≠ c√°c phi√™n
  function renderHistory() {
    const container = document.getElementById("history");
    container.innerHTML = "<h3>L·ªãch s·ª≠</h3>";
    history.forEach(h => {
      const div = document.createElement("div");
      div.className = "history-item";
      div.textContent = `Phi√™n ${h.phien} - Dice: ${h.ketQua} - T·ªïng: ${h.tong} - K·∫øt qu·∫£: ${h.taiXiu}`;
      container.appendChild(div);
    });
  }

  // ƒê·∫øm s·ªë d√≤ng code trong file HTML hi·ªán t·∫°i v√† hi·ªÉn th·ªã
  async function countCodeLines() {
    try {
      // L·∫•y URL file html hi·ªán t·∫°i
      const url = window.location.href.split('#')[0].split('?')[0];

      // N·∫øu ƒëang ch·∫°y local file://, kh√¥ng ƒë·ªçc ƒë∆∞·ª£c file => hi·ªÉn th·ªã th√¥ng b√°o
      if (url.startsWith("file://")) {
        document.getElementById("codeLineCount").textContent = "Ch·∫°y local file, kh√¥ng th·ªÉ ƒë·∫øm s·ªë d√≤ng code.";
        return;
      }

      // Fetch file html ch√≠nh m√¨nh
      const res = await fetch(url);
      const text = await res.text();

      // ƒê·∫øm s·ªë d√≤ng
      const lines = text.split(/\r\n|\r|\n/).length;

      document.getElementById("codeLineCount").textContent = "T·ªïng s·ªë d√≤ng code trong file n√†y: " + lines;

    } catch (err) {
      document.getElementById("codeLineCount").textContent = "Kh√¥ng th·ªÉ ƒë·∫øm s·ªë d√≤ng code: " + err.message;
      console.error(err);
    }
  }

  document.getElementById("btnLoad").addEventListener("click", loadData);

  // N·∫øu b·∫°n mu·ªën t·ª± ƒë·ªông load d·ªØ li·ªáu khi m·ªü trang, uncomment d√≤ng n√†y:
  // loadData();
</script>

</body>
</html>
